var slot1 = [{"from":"2020-05-12T21:00:00.000Z","name":"Golden Kamuy","picture":"golden-kamuy","day":19,"month":"May"},{"from":"2020-08-11T21:00:00.000Z","name":"Freedom","picture":"freedom","day":18,"month":"Aug"},{"from":"2020-09-08T21:00:00.000Z","name":"The Promised Neverland","picture":"promised-neverland","day":15,"month":"Sep"}];
var slot2 = [{"from":"2019-01-01T22:00:00.000Z","name":"Hunter &times; Hunter","picture":"hunter-x-hunter","day":8,"month":"Jan"},{"from":"2020-07-21T21:00:00.000Z","name":"Spice and Wolf","picture":"spice-and-wolf","day":28,"month":"Jul"}];
var slot3 = [{"from":"2020-04-28T21:00:00.000Z","name":"Hinamatsuri","picture":"hinamatsuri","day":5,"month":"May"},{"from":"2020-06-09T21:00:00.000Z","name":"Demi-chan wa Kataritai","picture":"demi-chan","day":16,"month":"Jun"},{"from":"2020-07-21T21:00:00.000Z","name":"Chio's School Road","picture":"chios-school-road","day":28,"month":"Jul"},{"from":"2020-09-01T21:00:00.000Z","name":"Konosuba S2","picture":"konosuba2","day":8,"month":"Sep"}];

var events = [{"date":"2020-06-09T18:00:00.000Z","shortDate":"2020-06-09","month":"Jun","day":9,"class":"online","events":[{"date":"2020-06-09T18:00:00.000Z","dateLong":"Tuesday, 9 June 2020, 7pm","time":"7pm","day":9,"month":"Jun","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-06-16T00:00:00.000Z","shortDate":"2020-06-16","month":"Jun","day":16,"class":"new-series","events":[{"date":"2020-06-16T00:00:00.000Z","dateLong":"Tuesday, 16 June 2020, 9pm","day":16,"month":"Jun","name":"New series: Demi-chan wa Kataritai","class":"new-series"},{"date":"2020-06-16T18:00:00.000Z","dateLong":"Tuesday, 16 June 2020, 7pm","time":"7pm","day":16,"month":"Jun","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-06-23T18:00:00.000Z","shortDate":"2020-06-23","month":"Jun","day":23,"class":"online","events":[{"date":"2020-06-23T18:00:00.000Z","dateLong":"Tuesday, 23 June 2020, 7pm","time":"7pm","day":23,"month":"Jun","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-06-30T18:00:00.000Z","shortDate":"2020-06-30","month":"Jun","day":30,"class":"online","events":[{"date":"2020-06-30T18:00:00.000Z","dateLong":"Tuesday, 30 June 2020, 7pm","time":"7pm","day":30,"month":"Jun","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-07-07T18:00:00.000Z","shortDate":"2020-07-07","month":"Jul","day":7,"class":"online","events":[{"date":"2020-07-07T18:00:00.000Z","dateLong":"Tuesday, 7 July 2020, 7pm","time":"7pm","day":7,"month":"Jul","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-07-14T18:00:00.000Z","shortDate":"2020-07-14","month":"Jul","day":14,"class":"online","events":[{"date":"2020-07-14T18:00:00.000Z","dateLong":"Tuesday, 14 July 2020, 7pm","time":"7pm","day":14,"month":"Jul","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-07-21T18:00:00.000Z","shortDate":"2020-07-21","month":"Jul","day":21,"class":"online","events":[{"date":"2020-07-21T18:00:00.000Z","dateLong":"Tuesday, 21 July 2020, 7pm","time":"7pm","day":21,"month":"Jul","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-07-28T00:00:00.000Z","shortDate":"2020-07-28","month":"Jul","day":28,"class":"new-series","events":[{"date":"2020-07-28T00:00:00.000Z","dateLong":"Tuesday, 28 July 2020, 8pm","day":28,"month":"Jul","name":"New series: Spice and Wolf","class":"new-series"},{"date":"2020-07-28T00:00:00.000Z","dateLong":"Tuesday, 28 July 2020, 9pm","day":28,"month":"Jul","name":"New series: Chio's School Road","class":"new-series"},{"date":"2020-07-28T18:00:00.000Z","dateLong":"Tuesday, 28 July 2020, 7pm","time":"7pm","day":28,"month":"Jul","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-08-04T18:00:00.000Z","shortDate":"2020-08-04","month":"Aug","day":4,"class":"online","events":[{"date":"2020-08-04T18:00:00.000Z","dateLong":"Tuesday, 4 August 2020, 7pm","time":"7pm","day":4,"month":"Aug","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-08-11T18:00:00.000Z","shortDate":"2020-08-11","month":"Aug","day":11,"class":"online","events":[{"date":"2020-08-11T18:00:00.000Z","dateLong":"Tuesday, 11 August 2020, 7pm","time":"7pm","day":11,"month":"Aug","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-08-18T00:00:00.000Z","shortDate":"2020-08-18","month":"Aug","day":18,"class":"new-series","events":[{"date":"2020-08-18T00:00:00.000Z","dateLong":"Tuesday, 18 August 2020, 7pm","day":18,"month":"Aug","name":"New series: Freedom","class":"new-series"},{"date":"2020-08-18T18:00:00.000Z","dateLong":"Tuesday, 18 August 2020, 7pm","time":"7pm","day":18,"month":"Aug","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-08-25T18:00:00.000Z","shortDate":"2020-08-25","month":"Aug","day":25,"class":"online","events":[{"date":"2020-08-25T18:00:00.000Z","dateLong":"Tuesday, 25 August 2020, 7pm","time":"7pm","day":25,"month":"Aug","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-09-01T18:00:00.000Z","shortDate":"2020-09-01","month":"Sep","day":1,"class":"online","events":[{"date":"2020-09-01T18:00:00.000Z","dateLong":"Tuesday, 1 September 2020, 7pm","time":"7pm","day":1,"month":"Sep","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-09-08T00:00:00.000Z","shortDate":"2020-09-08","month":"Sep","day":8,"class":"new-series","events":[{"date":"2020-09-08T00:00:00.000Z","dateLong":"Tuesday, 8 September 2020, 9pm","day":8,"month":"Sep","name":"New series: Konosuba S2","class":"new-series"},{"date":"2020-09-08T18:00:00.000Z","dateLong":"Tuesday, 8 September 2020, 7pm","time":"7pm","day":8,"month":"Sep","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-09-15T00:00:00.000Z","shortDate":"2020-09-15","month":"Sep","day":15,"class":"new-series","events":[{"date":"2020-09-15T00:00:00.000Z","dateLong":"Tuesday, 15 September 2020, 7pm","day":15,"month":"Sep","name":"New series: The Promised Neverland","class":"new-series"},{"date":"2020-09-15T18:00:00.000Z","dateLong":"Tuesday, 15 September 2020, 7pm","time":"7pm","day":15,"month":"Sep","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-09-22T18:00:00.000Z","shortDate":"2020-09-22","month":"Sep","day":22,"class":"online","events":[{"date":"2020-09-22T18:00:00.000Z","dateLong":"Tuesday, 22 September 2020, 7pm","time":"7pm","day":22,"month":"Sep","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-09-29T18:00:00.000Z","shortDate":"2020-09-29","month":"Sep","day":29,"class":"online","events":[{"date":"2020-09-29T18:00:00.000Z","dateLong":"Tuesday, 29 September 2020, 7pm","time":"7pm","day":29,"month":"Sep","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-10-06T18:00:00.000Z","shortDate":"2020-10-06","month":"Oct","day":6,"class":"online","events":[{"date":"2020-10-06T18:00:00.000Z","dateLong":"Tuesday, 6 October 2020, 7pm","time":"7pm","day":6,"month":"Oct","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-10-13T18:00:00.000Z","shortDate":"2020-10-13","month":"Oct","day":13,"class":"online","events":[{"date":"2020-10-13T18:00:00.000Z","dateLong":"Tuesday, 13 October 2020, 7pm","time":"7pm","day":13,"month":"Oct","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]},{"date":"2020-10-20T18:00:00.000Z","shortDate":"2020-10-20","month":"Oct","day":20,"class":"online","events":[{"date":"2020-10-20T18:00:00.000Z","dateLong":"Tuesday, 20 October 2020, 7pm","time":"7pm","day":20,"month":"Oct","name":"Online Meeting","class":"online","price":null,"venue":"Discord","address":""}]}];

var options = {"online":true,"hiatus":false,"hiatusMessage":"Our regular schedule resumes on 28 April"};

// select a background image
function selectBackground() {
    var DAY_LIMIT = 4;
    var NIGHT_LIMIT = 7;

    var hour = new Date().getHours();
    var isDay = hour >= 6 && hour < 18;
    var bgNum = 1+Math.floor(Math.random() * (isDay ? DAY_LIMIT : NIGHT_LIMIT));
    var bodyClass = (isDay ? "day day-" : "night night-")+bgNum;

    document.getElementsByTagName("BODY")[0].className = bodyClass;
}

window.onload = function () {
  var now = new Date(Date.now());

  // adjust the showing anime
  function showingAnime(slot) {
    var before = slot.filter(function (series) {
      return Date.parse(series.from) < now;
    });
    return before[before.length - 1];
  }

  function nextAnime(slot) {
    var after = slot.filter(function (series) {
      return Date.parse(series.from) >= now;
    });
    return after[0];
  }

  var currentSlot1 = showingAnime(slot1);
  var currentSlot2 = showingAnime(slot2);
  var currentSlot3 = showingAnime(slot3);

  var nextSlot1 = nextAnime(slot1);
  var nextSlot2 = nextAnime(slot2);
  var nextSlot3 = nextAnime(slot3);

  function editSlot(id, series) {
    document.getElementById(id+'name').innerHTML = series.name;
    document.getElementById(id+'picture').setAttribute('src', 'images/series/'+series.picture+'.png');
  }

  editSlot('slot1', currentSlot1);
  editSlot('slot2', currentSlot2);
  editSlot('slot3', currentSlot3);

  editSlot('nextSlot1', nextSlot1);
  editSlot('nextSlot2', nextSlot2);
  editSlot('nextSlot3', nextSlot3);

  // adjust the events list
  events = events.filter(function (event) {
    return Date.parse(event.date) >= now;
  });
  events = events.slice(0, 12);
  // var nextEvent = events[0].events[0];

  var eventsHTML = '';
  var event;
  for (event of events) {
    var html = "<article id='upcoming-"+event.date+"' class='event event-"+event.class+"'>\n"+
      "<time datetime='"+event.date+"'><span class='day'>"+event.day+"</span><span class='month'>"+event.month+"</span></time>\n";
    for (ev of event.events) {
      var time = false;
      if (ev.hasOwnProperty("time")) {
        time = ev.time;
      }
      var a = "";
      var _a = "";
      if (ev.hasOwnProperty("link")) {
        a = "<a href='"+ev.link+"'>";
        _a = "</a>";
      }
      html = html +"<div class='event-detail event-detail-"+ev.class+"'><h3>"+ev.name+"</h3>\n";
      if (ev.hasOwnProperty("time")) {
        html = html+"<p>"+a+ev.venue+(time ? ", "+time : "")+_a+"</p>\n";
      }
      if (ev.price) {
        html = html + "<p>Attendance fee: "+ev.price+"</p>";
      }
      html = html+"</div>";
    };
    html = html + "</article>\n";
    eventsHTML = eventsHTML + html;
  }
  document.getElementById('events-list').innerHTML = eventsHTML;

  // adjust the next event headline
  var mainEvents = [];
  for (event of events) {
    for (ev of event.events) {
      switch (event.class) {
        case 'esports':
        case 'cinema':
        case 'skip':
        case 'new-series':
          continue;

        default:
          mainEvents.push(ev);
      }
    }
  }
  var nextEvent = mainEvents[0];
  document.getElementById('next-meeting-date').innerHTML = nextEvent.dateLong;
  document.getElementById('next-meeting-title').innerHTML = (nextEvent.name == 'Anime Society Meeting' ? '' : nextEvent.name);
  if (document.getElementById('next-meeting-venue')) {
    document.getElementById('next-meeting-venue').innerHTML = nextEvent.venue;
  }
  if (document.getElementById('next-meeting-address')) {
    document.getElementById('next-meeting-address').innerHTML = nextEvent.address;
  }

  selectBackground();
};
setInterval(selectBackground, 300000); // 5 minutes

function showMap() {
  document.getElementById('blanket').className = "hide";
  document.getElementById('map-overlay').className = "hide";
  setTimeout(() => {
    document.getElementById('blanket').className = "show";
    document.getElementById('map-overlay').className = "show";
  }, 1);
}

function showNews() {
  document.getElementById('news-more-switch').className = "hide";
  document.getElementById('news-more').className = "show";
}

function hideMap() {
  document.getElementById('blanket').className = "hide";
  document.getElementById('map-overlay').className = "hide";
  setTimeout(() => {
    document.getElementById('blanket').className = "";
    document.getElementById('map-overlay').className = "";
  }, 500);
}
